<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>FRAMLGRAPH — Transaction Relationship Intelligence</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.28.1/cytoscape.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet"/>
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    html,body,#root{height:100%;width:100%;overflow:hidden}
    body{background:#060c1a;font-family:'DM Sans',sans-serif}
    ::-webkit-scrollbar{width:5px;height:5px}
    ::-webkit-scrollbar-track{background:transparent}
    ::-webkit-scrollbar-thumb{background:rgba(99,102,241,.3);border-radius:10px}
    @keyframes spin{to{transform:rotate(360deg)}}
    @keyframes pulse{0%,100%{opacity:.35}50%{opacity:.7}}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    @keyframes slideUp{from{opacity:0;transform:translateY(32px)}to{opacity:1;transform:translateY(0)}}
    @keyframes slideInL{from{opacity:0;transform:translateX(-14px)}to{opacity:1;transform:translateX(0)}}
    @keyframes slideInR{from{opacity:0;transform:translateX(14px)}to{opacity:1;transform:translateX(0)}}
    .data-row:hover{background:rgba(99,102,241,.07)!important}
    .data-row.selected{background:rgba(99,102,241,.16)!important;outline:1px solid rgba(99,102,241,.35)}
    .icon-btn:hover{background:rgba(255,255,255,.1)!important;color:#c7d2fe!important}
    .ctrl-btn:hover{background:#4338ca!important}
    .ghost-btn:hover{background:rgba(99,102,241,.1)!important}
    .danger-btn:hover{background:rgba(239,68,68,.15)!important}
    .page-btn:hover:not(:disabled){background:rgba(99,102,241,.15)!important;color:#c7d2fe!important}
    .page-btn:disabled{opacity:.3;cursor:not-allowed}
    .edge-pill:hover{opacity:1!important}
    .explore-btn:hover{background:rgba(79,70,229,.28)!important}
    .pm-peer:hover{background:rgba(236,72,153,.12)!important}
    .landing-btn:hover{transform:translateY(-2px);box-shadow:0 8px 32px rgba(99,102,241,.4)!important}
    .landing-card:hover{border-color:rgba(99,102,241,.35)!important;transform:translateY(-3px)}
    input:focus,select:focus{border-color:rgba(99,102,241,.6)!important;box-shadow:0 0 0 2px rgba(99,102,241,.1);outline:none}
    .modal-overlay{animation:fadeIn .15s ease}
    .modal-card{animation:slideUp .2s ease}
    .filter-panel{animation:slideInL .18s ease}
    .detail-panel{animation:slideInR .18s ease}
    .payment-panel{animation:slideInR .2s ease}
    .cy-tooltip{
      position:absolute;background:rgba(7,13,26,.97);border:1px solid rgba(99,102,241,.3);
      border-radius:8px;padding:10px 14px;font-size:11px;color:#c7d2fe;
      font-family:'DM Mono',monospace;pointer-events:none;z-index:9999;
      backdrop-filter:blur(14px);box-shadow:0 8px 32px rgba(0,0,0,.5);
      animation:fadeIn .1s ease;max-width:280px
    }
    .pm-chip{
      display:inline-flex;align-items:center;gap:5px;background:rgba(236,72,153,.1);
      border:1px solid rgba(236,72,153,.28);border-radius:20px;padding:2px 10px;
      font-size:10px;color:#f9a8d4;cursor:pointer;transition:all .15s
    }
    .pm-chip:hover{background:rgba(236,72,153,.2)!important}
    .pm-chip .del{color:#64748b;font-size:12px;cursor:pointer}
    .pm-chip .del:hover{color:#f87171}
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const {useState,useEffect,useRef,useCallback,useMemo}=React;

const API_BASE="http://localhost:8080";

const EDGE_COLORS={
  SAME_EMAIL:"#f59e0b",SAME_PHONE:"#10b981",SAME_ADDRESS:"#8b5cf6",
  SAME_PAYMENT:"#ec4899",
  SENT:"#3b82f6",RECEIVED_BY:"#06b6d4",SAME_IP:"#f97316",SAME_DEVICE:"#84cc16",
};
const NODE_COLORS={user:"#4f46e5",transaction:"#7c3aed",payment_method:"#ec4899"};
const ALL_EDGE_TYPES=Object.keys(EDGE_COLORS);
const STATUS_COLORS={COMPLETED:"#34d399",PENDING:"#fbbf24",FAILED:"#f87171",FLAGGED:"#f43f5e",REVERSED:"#a78bfa"};
const CURRENCY_SYMS={USD:"$",EUR:"€",GBP:"£",INR:"₹"};
const STATUS_OPTS=["PENDING","COMPLETED","FAILED","FLAGGED","REVERSED"];
const CURRENCY_OPTS=["USD","EUR","GBP","INR","AUD"];
const PAYMENT_SUGGESTIONS=["CREDIT_CARD","DEBIT_CARD","CASH","BANK_TRANSFER","UPI","PAYPAL","CRYPTO"];

function fmtAmt(v,cur){if(v==null)return"—";const s=CURRENCY_SYMS[cur]||(cur?cur+" ":"$");return s+Number(v).toLocaleString(undefined,{minimumFractionDigits:2});}
function fmtTime(ts){if(!ts)return null;try{return new Date(ts).toLocaleString(undefined,{dateStyle:"medium",timeStyle:"short"});}catch{return ts;}}

async function apiFetch(path,opts){
  const res=await fetch(`${API_BASE}${path}`,opts);
  if(!res.ok)throw new Error(`API Error ${res.status}: ${res.statusText}`);
  return res.json();
}

/* ══════════════════════════════════════════════════════════════
   LANDING PAGE
══════════════════════════════════════════════════════════════ */
function LandingPage({onEnter}){
  const canvasRef=useRef(null);
  useEffect(()=>{
    const canvas=canvasRef.current;if(!canvas)return;
    const ctx=canvas.getContext("2d");
    let W=canvas.width=window.innerWidth,H=canvas.height=window.innerHeight;
    const particles=Array.from({length:60},()=>({x:Math.random()*W,y:Math.random()*H,r:Math.random()*1.5+.5,vx:(Math.random()-.5)*.3,vy:-(Math.random()*.4+.1),alpha:Math.random()*.5+.1}));
    let raf;
    const draw=()=>{
      ctx.clearRect(0,0,W,H);ctx.strokeStyle="rgba(99,102,241,0.06)";ctx.lineWidth=1;
      particles.forEach((p,i)=>{particles.slice(i+1).forEach(q=>{const d=Math.hypot(p.x-q.x,p.y-q.y);if(d<120){ctx.globalAlpha=(120-d)/120*.08;ctx.beginPath();ctx.moveTo(p.x,p.y);ctx.lineTo(q.x,q.y);ctx.stroke();}});});
      particles.forEach(p=>{ctx.globalAlpha=p.alpha;ctx.fillStyle="#818cf8";ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fill();p.x+=p.vx;p.y+=p.vy;if(p.y<-10){p.y=H+10;p.x=Math.random()*W;}if(p.x<-10)p.x=W+10;if(p.x>W+10)p.x=-10;});
      ctx.globalAlpha=1;raf=requestAnimationFrame(draw);
    };
    draw();const resize=()=>{W=canvas.width=window.innerWidth;H=canvas.height=window.innerHeight;};
    window.addEventListener("resize",resize);return()=>{cancelAnimationFrame(raf);window.removeEventListener("resize",resize);};
  },[]);
  return(
    <div style={{position:"relative",width:"100vw",height:"100vh",overflow:"hidden",background:"#060c1a",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center"}}>
      <canvas ref={canvasRef} style={{position:"absolute",inset:0,pointerEvents:"none"}}/>
      <div style={{position:"absolute",top:"10%",left:"20%",width:400,height:400,borderRadius:"50%",background:"radial-gradient(circle,rgba(79,70,229,.12) 0%,transparent 70%)",pointerEvents:"none"}}/>
      <div style={{position:"absolute",bottom:"15%",right:"15%",width:350,height:350,borderRadius:"50%",background:"radial-gradient(circle,rgba(124,58,237,.1) 0%,transparent 70%)",pointerEvents:"none"}}/>
      <div style={{position:"relative",zIndex:2,textAlign:"center",maxWidth:760,padding:"0 24px"}}>
        <div style={{display:"flex",alignItems:"center",justifyContent:"center",gap:12,marginBottom:24}}>
          <span style={{fontSize:44,color:"#818cf8",lineHeight:1}}>⬡</span>
          <span style={{fontSize:42,fontWeight:800,letterSpacing:"0.14em",color:"#f1f5f9",fontFamily:"'DM Mono',monospace"}}>FRAML<span style={{color:"#818cf8"}}>GRAPH</span></span>
        </div>
        <div style={{fontSize:13,color:"#334155",letterSpacing:"0.15em",textTransform:"uppercase",marginBottom:48}}>Transaction Relationship Intelligence Platform</div>
        <div style={{display:"flex",gap:16,marginBottom:48,justifyContent:"center",flexWrap:"wrap"}}>
          {[{icon:"◉",title:"User Profiles",desc:"Manage users with shared attribute detection across email, phone, address & payment methods"},{icon:"⬡",title:"Transaction Flow",desc:"Track fund movements with status, currency, device & IP metadata for every transaction"},{icon:"⬣",title:"Graph Intelligence",desc:"Visualise relationship networks — filter, search, highlight nodes and edges"}].map(f=>(
            <div key={f.title} className="landing-card" style={{background:"rgba(15,23,42,.8)",border:"1px solid rgba(99,102,241,.15)",borderRadius:12,padding:"20px 18px",width:220,textAlign:"left",backdropFilter:"blur(12px)",transition:"all .25s"}}>
              <div style={{fontSize:22,marginBottom:10,color:"#818cf8"}}>{f.icon}</div>
              <div style={{fontSize:13,fontWeight:700,color:"#e2e8f0",marginBottom:6}}>{f.title}</div>
              <div style={{fontSize:11,color:"#475569",lineHeight:1.6}}>{f.desc}</div>
            </div>
          ))}
        </div>
        <button className="landing-btn" onClick={onEnter} style={{background:"linear-gradient(135deg,#4f46e5,#7c3aed)",border:"none",borderRadius:12,color:"#fff",padding:"16px 48px",fontSize:15,fontWeight:800,cursor:"pointer",letterSpacing:"0.08em",boxShadow:"0 4px 24px rgba(99,102,241,.3)",transition:"all .25s"}}>LAUNCH DASHBOARD →</button>
        <div style={{marginTop:20,fontSize:11,color:"#1e293b",letterSpacing:"0.06em"}}>Powered by Neo4j · Spring Boot · React · Cytoscape.js</div>
      </div>
    </div>
  );
}

/* ══════════════════════════════════════════════════════════════
   MODAL WRAPPER
══════════════════════════════════════════════════════════════ */
function Modal({title,onClose,children,width=520}){
  useEffect(()=>{const h=e=>{if(e.key==="Escape")onClose();};window.addEventListener("keydown",h);return()=>window.removeEventListener("keydown",h);},[onClose]);
  return(
    <div className="modal-overlay" onClick={onClose} style={{position:"fixed",inset:0,background:"rgba(3,7,18,.8)",backdropFilter:"blur(6px)",zIndex:100,display:"flex",alignItems:"center",justifyContent:"center",padding:16}}>
      <div className="modal-card" onClick={e=>e.stopPropagation()} style={{background:"#0c1628",border:"1px solid rgba(99,102,241,.25)",borderRadius:14,width:"100%",maxWidth:width,maxHeight:"90vh",display:"flex",flexDirection:"column",boxShadow:"0 24px 80px rgba(0,0,0,.6)"}}>
        <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"16px 20px",borderBottom:"1px solid rgba(255,255,255,.06)"}}>
          <span style={{fontSize:14,fontWeight:700,color:"#c7d2fe",letterSpacing:"0.04em"}}>{title}</span>
          <button onClick={onClose} style={{background:"none",border:"none",color:"#334155",cursor:"pointer",fontSize:20,lineHeight:1,padding:"0 4px"}}>×</button>
        </div>
        <div style={{flex:1,overflowY:"auto",padding:"20px"}}>{children}</div>
      </div>
    </div>
  );
}

/* ── Form helpers ── */
const Fi=({label,children,hint})=>(<div style={{marginBottom:14}}><div style={{fontSize:10,color:"#475569",textTransform:"uppercase",letterSpacing:"0.07em",marginBottom:5}}>{label}{hint&&<span style={{color:"#334155",marginLeft:6,textTransform:"none",letterSpacing:"normal",fontSize:9}}>{hint}</span>}</div>{children}</div>);
const Inp=({...p})=>(<input {...p} style={{width:"100%",background:"rgba(255,255,255,.05)",border:"1px solid rgba(99,102,241,.18)",borderRadius:7,color:"#e2e8f0",padding:"8px 11px",fontSize:12,outline:"none",fontFamily:"'DM Sans',sans-serif",transition:"border-color .2s",...(p.style||{})}}/>);
const Sel=({children,...p})=>(<select {...p} style={{width:"100%",background:"#0c1628",border:"1px solid rgba(99,102,241,.18)",borderRadius:7,color:"#e2e8f0",padding:"8px 11px",fontSize:12,cursor:"pointer",...(p.style||{})}}>{children}</select>);

/* ══════════════════════════════════════════════════════════════
   USER MODAL
══════════════════════════════════════════════════════════════ */
function UserModal({editUser,onClose,onSaved}){
  const isEdit=!!editUser;
  const [form,setForm]=useState({userId:editUser?.userId||"",name:editUser?.name||"",email:editUser?.email||"",phone:editUser?.phone||"",address:editUser?.address||"",paymentMethods:editUser?.paymentMethods||[]});
  const [pmInput,setPmInput]=useState("");const [loading,setLoading]=useState(false);const [error,setError]=useState(null);
  const set=k=>v=>setForm(f=>({...f,[k]:v}));
  const addPm=()=>{const v=pmInput.trim();if(v&&!form.paymentMethods.includes(v))setForm(f=>({...f,paymentMethods:[...f.paymentMethods,v]}));setPmInput("");};
  const removePm=pm=>setForm(f=>({...f,paymentMethods:f.paymentMethods.filter(x=>x!==pm)}));
  const submit=async()=>{
    if(!form.userId.trim()||!form.name.trim()){setError("User ID and Name are required.");return;}
    setLoading(true);setError(null);
    try{await apiFetch("/users",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(form)});onSaved();onClose();}
    catch(e){setError(e.message);}finally{setLoading(false);}
  };
  return(
    <Modal title={isEdit?"Edit User":"Add New User"} onClose={onClose}>
      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"0 14px"}}>
        <Fi label="User ID *"><Inp value={form.userId} onChange={e=>set("userId")(e.target.value)} placeholder="USR-001" disabled={isEdit} style={isEdit?{opacity:.5,cursor:"not-allowed"}:{}}/></Fi>
        <Fi label="Name *"><Inp value={form.name} onChange={e=>set("name")(e.target.value)} placeholder="John Doe"/></Fi>
        <Fi label="Email"><Inp type="email" value={form.email} onChange={e=>set("email")(e.target.value)} placeholder="john@example.com"/></Fi>
        <Fi label="Phone"><Inp value={form.phone} onChange={e=>set("phone")(e.target.value)} placeholder="+1-555-0000"/></Fi>
      </div>
      <Fi label="Address"><Inp value={form.address} onChange={e=>set("address")(e.target.value)} placeholder="123 Main St"/></Fi>
      <Fi label="Payment Methods" hint="(Enter or + to add)">
        <div style={{display:"flex",gap:6,marginBottom:8}}>
          <div style={{flex:1,position:"relative"}}>
            <Inp value={pmInput} onChange={e=>setPmInput(e.target.value)} onKeyDown={e=>{if(e.key==="Enter"){e.preventDefault();addPm();}}} placeholder="CREDIT_CARD, PAYPAL…"/>
            {pmInput&&(<div style={{position:"absolute",top:"100%",left:0,right:0,background:"#0c1628",border:"1px solid rgba(99,102,241,.25)",borderRadius:7,zIndex:10,marginTop:3,overflow:"hidden"}}>
              {PAYMENT_SUGGESTIONS.filter(s=>s.toLowerCase().includes(pmInput.toLowerCase())&&!form.paymentMethods.includes(s)).slice(0,5).map(s=>(
                <div key={s} onClick={()=>{setForm(f=>({...f,paymentMethods:[...f.paymentMethods,s]}));setPmInput("");}} style={{padding:"7px 11px",fontSize:12,color:"#94a3b8",cursor:"pointer",borderBottom:"1px solid rgba(255,255,255,.04)"}} className="data-row">{s}</div>
              ))}
            </div>)}
          </div>
          <button className="ctrl-btn" onClick={addPm} style={{background:"#4f46e5",border:"none",borderRadius:7,color:"#fff",padding:"0 14px",fontSize:16,cursor:"pointer",flexShrink:0}}>+</button>
        </div>
        <div style={{display:"flex",flexWrap:"wrap",gap:6,minHeight:28}}>
          {form.paymentMethods.length===0&&<span style={{fontSize:10,color:"#1e293b",fontStyle:"italic"}}>No payment methods added</span>}
          {form.paymentMethods.map(pm=>(<span key={pm} className="pm-chip">{pm}<span className="del" onClick={()=>removePm(pm)}>×</span></span>))}
        </div>
      </Fi>
      {error&&<div style={{background:"rgba(239,68,68,.08)",border:"1px solid rgba(239,68,68,.2)",borderRadius:7,padding:"8px 12px",color:"#fca5a5",fontSize:12,marginBottom:12}}>{error}</div>}
      <div style={{display:"flex",gap:10,justifyContent:"flex-end",paddingTop:8}}>
        <button className="ghost-btn" onClick={onClose} style={{background:"transparent",border:"1px solid rgba(99,102,241,.25)",borderRadius:7,color:"#818cf8",padding:"9px 20px",fontSize:12,fontWeight:600,cursor:"pointer"}}>Cancel</button>
        <button className="ctrl-btn" onClick={submit} disabled={loading} style={{background:loading?"#334155":"#4f46e5",border:"none",borderRadius:7,color:"#fff",padding:"9px 24px",fontSize:12,fontWeight:700,cursor:"pointer"}}>{loading?"Saving…":isEdit?"Update User":"Add User"}</button>
      </div>
    </Modal>
  );
}

/* ══════════════════════════════════════════════════════════════
   TRANSACTION MODAL
══════════════════════════════════════════════════════════════ */
function TransactionModal({editTx,onClose,onSaved}){
  const isEdit=!!editTx;
  const [form,setForm]=useState({transactionId:editTx?.transactionId||"",senderId:editTx?.senderId||"",receiverId:editTx?.receiverId||"",amount:editTx?.amount||"",currency:editTx?.currency||"USD",status:editTx?.status||"PENDING",paymentMethod:editTx?.paymentMethod||"",ip:editTx?.ip||"",deviceId:editTx?.deviceId||""});
  const [loading,setLoading]=useState(false);const [error,setError]=useState(null);
  const set=k=>e=>setForm(f=>({...f,[k]:e.target.value}));
  const submit=async()=>{
    if(!form.transactionId.trim()){setError("Transaction ID is required.");return;}
    if(!form.senderId.trim()||!form.receiverId.trim()){setError("Sender and Receiver IDs are required.");return;}
    setLoading(true);setError(null);
    try{await apiFetch("/transactions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...form,amount:form.amount?Number(form.amount):null})});onSaved();onClose();}
    catch(e){setError(e.message);}finally{setLoading(false);}
  };
  return(
    <Modal title={isEdit?"Edit Transaction":"Add New Transaction"} onClose={onClose}>
      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"0 14px"}}>
        <Fi label="Transaction ID *"><Inp value={form.transactionId} onChange={set("transactionId")} placeholder="TXN-001" disabled={isEdit} style={isEdit?{opacity:.5,cursor:"not-allowed"}:{}}/></Fi>
        <Fi label="Status"><Sel value={form.status} onChange={set("status")}>{STATUS_OPTS.map(s=><option key={s} value={s}>{s}</option>)}</Sel></Fi>
        <Fi label="Sender User ID *"><Inp value={form.senderId} onChange={set("senderId")} placeholder="USR-001"/></Fi>
        <Fi label="Receiver User ID *"><Inp value={form.receiverId} onChange={set("receiverId")} placeholder="USR-002"/></Fi>
        <Fi label="Amount"><Inp type="number" value={form.amount} onChange={set("amount")} placeholder="1000.00"/></Fi>
        <Fi label="Currency"><Sel value={form.currency} onChange={set("currency")}>{CURRENCY_OPTS.map(c=><option key={c} value={c}>{c}</option>)}</Sel></Fi>
        <Fi label="Payment Method"><Inp value={form.paymentMethod} onChange={set("paymentMethod")} placeholder="CREDIT_CARD" list="pm-list"/><datalist id="pm-list">{PAYMENT_SUGGESTIONS.map(s=><option key={s} value={s}/>)}</datalist></Fi>
        <Fi label="IP Address"><Inp value={form.ip} onChange={set("ip")} placeholder="192.168.1.1"/></Fi>
        <Fi label="Device ID"><Inp value={form.deviceId} onChange={set("deviceId")} placeholder="DEV-ABC123"/></Fi>
      </div>
      {error&&<div style={{background:"rgba(239,68,68,.08)",border:"1px solid rgba(239,68,68,.2)",borderRadius:7,padding:"8px 12px",color:"#fca5a5",fontSize:12,marginBottom:12}}>{error}</div>}
      <div style={{display:"flex",gap:10,justifyContent:"flex-end",paddingTop:8}}>
        <button className="ghost-btn" onClick={onClose} style={{background:"transparent",border:"1px solid rgba(99,102,241,.25)",borderRadius:7,color:"#818cf8",padding:"9px 20px",fontSize:12,fontWeight:600,cursor:"pointer"}}>Cancel</button>
        <button className="ctrl-btn" onClick={submit} disabled={loading} style={{background:loading?"#334155":"#4f46e5",border:"none",borderRadius:7,color:"#fff",padding:"9px 24px",fontSize:12,fontWeight:700,cursor:"pointer"}}>{loading?"Saving…":isEdit?"Update":"Add Transaction"}</button>
      </div>
    </Modal>
  );
}

/* ══════════════════════════════════════════════════════════════
   PAYMENT SUMMARY PANEL
══════════════════════════════════════════════════════════════ */
function PaymentSummaryPanel({paymentSummary,userPaymentMethods,onClose,onExplorePeer}){
  if((!paymentSummary||paymentSummary.length===0)&&(!userPaymentMethods||userPaymentMethods.length===0))return null;
  const totalPeers=paymentSummary?paymentSummary.reduce((s,m)=>s+(m.peerCount||0),0):0;
  return(
    <div className="payment-panel" style={{position:"absolute",top:52,right:0,width:272,background:"rgba(7,13,26,.97)",border:"1px solid rgba(236,72,153,.2)",borderRight:"none",borderTop:"none",borderRadius:"0 0 0 10px",zIndex:24,backdropFilter:"blur(18px)",boxShadow:"-4px 12px 36px rgba(0,0,0,.45)",maxHeight:"calc(100% - 52px)",display:"flex",flexDirection:"column"}}>
      <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"11px 13px 9px",borderBottom:"1px solid rgba(255,255,255,.06)",flexShrink:0}}>
        <div style={{display:"flex",alignItems:"center",gap:8}}>
          <span style={{width:9,height:9,borderRadius:"2px",background:"#ec4899",display:"block",boxShadow:"0 0 8px #ec489988"}}/>
          <span style={{fontSize:10,fontWeight:700,color:"#c7d2fe",textTransform:"uppercase",letterSpacing:"0.09em"}}>Payment Methods</span>
        </div>
        <div style={{display:"flex",alignItems:"center",gap:8}}>
          <span style={{fontSize:9,color:"#ec4899",fontFamily:"'DM Mono',monospace",background:"rgba(236,72,153,.12)",padding:"2px 7px",borderRadius:10}}>{totalPeers} peers</span>
          <button className="icon-btn" onClick={onClose} style={{background:"none",border:"none",color:"#334155",cursor:"pointer",fontSize:16,padding:"1px 5px"}}>×</button>
        </div>
      </div>
      {userPaymentMethods&&userPaymentMethods.length>0&&(
        <div style={{padding:"9px 13px",borderBottom:"1px solid rgba(255,255,255,.04)"}}>
          <div style={{fontSize:8,color:"#334155",textTransform:"uppercase",letterSpacing:"0.1em",marginBottom:6}}>This User's Methods</div>
          <div style={{display:"flex",flexWrap:"wrap",gap:5}}>
            {userPaymentMethods.map(pm=>(<span key={pm} className="pm-chip" style={{fontSize:9}}>{pm}</span>))}
          </div>
        </div>
      )}
      <div style={{flex:1,overflowY:"auto",padding:"4px 0"}}>
        {paymentSummary&&paymentSummary.map((method,idx)=>(
          <div key={idx} style={{borderBottom:"1px solid rgba(255,255,255,.03)"}}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"9px 13px 5px"}}>
              <div style={{display:"flex",alignItems:"center",gap:7}}>
                <span style={{width:7,height:7,borderRadius:"50%",background:"#ec4899",display:"block"}}/>
                <span style={{fontSize:11,fontWeight:700,color:"#f9a8d4"}}>{method.method}</span>
              </div>
              <span style={{fontSize:9,color:"#334155",fontFamily:"'DM Mono',monospace"}}>{method.peerCount} user{method.peerCount!==1?"s":""}</span>
            </div>
            {method.peers&&method.peers.length>0&&(
              <div style={{padding:"2px 13px 8px 27px"}}>
                {method.peers.map((peer,pidx)=>(
                  <div key={pidx} className="pm-peer" onClick={()=>onExplorePeer&&onExplorePeer(peer)} style={{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"4px 8px",borderRadius:4,cursor:"pointer",transition:"background .15s",marginBottom:1}}>
                    <div style={{display:"flex",alignItems:"center",gap:6}}>
                      <span style={{width:5,height:5,borderRadius:"50%",background:"#4f46e5",display:"block",opacity:.6}}/>
                      <span style={{fontSize:10,color:"#64748b"}}>{peer.name}</span>
                    </div>
                    <span style={{fontSize:8,color:"#1e293b",fontFamily:"'DM Mono',monospace"}}>{peer.userId}</span>
                  </div>
                ))}
                {method.peerCount>method.peers.length&&(<div style={{fontSize:9,color:"#334155",padding:"3px 8px",fontStyle:"italic"}}>+{method.peerCount-method.peers.length} more</div>)}
              </div>
            )}
          </div>
        ))}
      </div>
      <div style={{padding:"8px 13px",borderTop:"1px solid rgba(255,255,255,.04)",flexShrink:0}}>
        <div style={{fontSize:8,color:"#1e293b",letterSpacing:"0.08em"}}>Click any peer to explore their graph · Peers also shown as nodes in graph</div>
      </div>
    </div>
  );
}

/* ══════════════════════════════════════════════════════════════
   DETAIL PANEL
══════════════════════════════════════════════════════════════ */
function DetailPanel({selected,onClose,onExplore,onEdit}){
  if(!selected)return null;
  const isNode=selected.group==="nodes",d=selected.data;
  const isTx=isNode&&d.type==="transaction";
  const isPm=isNode&&d.type==="payment_method";
  const accent=isNode?(NODE_COLORS[d.type]||"#64748b"):(EDGE_COLORS[d.type]||"#94a3b8");
  let rows;
  if(isTx){rows=[["Tx ID",d.transactionId||d.id],d.amount!=null?["Amount",fmtAmt(d.amount,d.currency)]:null,d.currency?["Currency",d.currency]:null,d.paymentMethod?["Payment",d.paymentMethod]:null,d.status?["Status",d.status]:null,d.ip?["IP",d.ip]:null,d.deviceId?["Device",d.deviceId]:null,d.timestamp?["Time",fmtTime(d.timestamp)]:null].filter(Boolean);}
  else if(isPm){rows=[["ID",d.id],["Method",d.label],["Type","Payment Method"],d.userCount!=null?["Shared By",d.userCount+" users"]:null].filter(Boolean);}
  else if(isNode){rows=[["ID",d.id],["Name",d.label],["Type",d.type]];}
  else{rows=[["Type",d.type],["Source",d.source],["Target",d.target]];}
  return(
    <div className="detail-panel" style={{position:"absolute",top:52,right:0,width:262,background:"rgba(7,13,26,.97)",border:"1px solid rgba(99,102,241,.2)",borderRight:"none",borderTop:"none",borderRadius:"0 0 0 10px",zIndex:25,backdropFilter:"blur(18px)",boxShadow:"-4px 12px 36px rgba(0,0,0,.45)",maxHeight:"calc(100% - 52px)",display:"flex",flexDirection:"column"}}>
      <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"11px 13px 9px",borderBottom:"1px solid rgba(255,255,255,.06)",flexShrink:0}}>
        <div style={{display:"flex",alignItems:"center",gap:8}}>
          <span style={{width:9,height:9,borderRadius:isPm?"2px":isTx||!isNode?"2px":"50%",background:accent,display:"block",transform:isTx||!isNode?"rotate(45deg)":isPm?"none":"none",boxShadow:`0 0 8px ${accent}88`}}/>
          <span style={{fontSize:10,fontWeight:700,color:"#c7d2fe",textTransform:"uppercase",letterSpacing:"0.09em"}}>{isNode?d.type==="payment_method"?"Payment Method":d.type:"Edge"} Detail</span>
        </div>
        <button className="icon-btn" onClick={onClose} style={{background:"none",border:"none",color:"#334155",cursor:"pointer",fontSize:16,padding:"1px 5px"}}>×</button>
      </div>
      <div style={{flex:1,overflowY:"auto",padding:"6px 0"}}>
        {rows.map(([k,v])=>{const isStatus=k==="Status",isAmt=k==="Amount",isPayment=k==="Payment"||k==="Method";const sc=isStatus?(STATUS_COLORS[(v||"").toUpperCase()]||"#64748b"):null;return(
          <div key={k} style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",padding:"7px 13px",borderBottom:"1px solid rgba(255,255,255,.03)",gap:8}}>
            <span style={{fontSize:9,color:"#334155",textTransform:"uppercase",letterSpacing:"0.08em",flexShrink:0,paddingTop:1}}>{k}</span>
            <span style={{fontSize:11,fontFamily:"'DM Mono',monospace",textAlign:"right",wordBreak:"break-all",color:isStatus?sc:isAmt?"#34d399":isPayment?"#ec4899":(k==="Type")?accent:"#64748b",fontWeight:isAmt||isStatus?700:400}}>
              {isStatus?<span style={{background:`${sc}18`,border:`1px solid ${sc}44`,borderRadius:10,padding:"1px 8px",fontSize:9}}>{v}</span>:String(v||"—")}
            </span>
          </div>
        );})}
      </div>
      {isNode&&!isPm&&(<div style={{padding:"9px 13px",borderTop:"1px solid rgba(255,255,255,.04)",flexShrink:0,display:"flex",flexDirection:"column",gap:6}}>
        <button className="explore-btn" onClick={()=>onExplore(d)} style={{background:"rgba(79,70,229,.12)",border:"1px solid rgba(79,70,229,.35)",borderRadius:6,color:"#818cf8",padding:"7px",fontSize:11,fontWeight:700,cursor:"pointer",transition:"all .15s"}}>⬡ Explore {d.type==="user"?"User":"Transaction"} Graph</button>
        {onEdit&&<button onClick={()=>onEdit(d)} style={{background:"rgba(99,102,241,.07)",border:"1px solid rgba(99,102,241,.2)",borderRadius:6,color:"#64748b",padding:"7px",fontSize:11,cursor:"pointer"}}>✎ Edit</button>}
      </div>)}
    </div>
  );
}

/* ══════════════════════════════════════════════════════════════
   GRAPH FILTER SIDEBAR
══════════════════════════════════════════════════════════════ */
function GraphFilterPanel({graphData,activeEdgeTypes,setActiveEdgeTypes,activeNodeTypes,setActiveNodeTypes,searchTerm,setSearchTerm,onSearch}){
  if(!graphData)return null;
  const edgeCounts=useMemo(()=>{const c={};graphData.edges.forEach(e=>{c[e.type]=(c[e.type]||0)+1});return c;},[graphData]);
  const nodeCounts=useMemo(()=>{const c={};graphData.nodes.forEach(n=>{c[n.type]=(c[n.type]||0)+1});return c;},[graphData]);
  const presentEdges=ALL_EDGE_TYPES.filter(t=>edgeCounts[t]);const allOn=presentEdges.every(t=>activeEdgeTypes.includes(t));
  const allNodeTypes=["user","transaction","payment_method"];
  return(
    <div className="filter-panel" style={{position:"absolute",top:52,left:0,width:216,background:"rgba(7,13,26,.97)",border:"1px solid rgba(99,102,241,.2)",borderLeft:"none",borderTop:"none",borderRadius:"0 0 10px 0",zIndex:25,backdropFilter:"blur(18px)",boxShadow:"4px 12px 36px rgba(0,0,0,.45)",overflowY:"auto",maxHeight:"calc(100% - 52px)"}}>
      <div style={{padding:"11px 12px 8px"}}>
        <div style={{fontSize:8,color:"#1e293b",textTransform:"uppercase",letterSpacing:"0.12em",marginBottom:7}}>Search Nodes</div>
        <div style={{display:"flex",gap:5}}>
          <input style={{flex:1,background:"rgba(255,255,255,.05)",border:"1px solid rgba(99,102,241,.18)",borderRadius:6,color:"#e2e8f0",padding:"5px 8px",fontSize:11,outline:"none",fontFamily:"'DM Mono',monospace"}} placeholder="Name, ID…" value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} onKeyDown={e=>e.key==="Enter"&&onSearch()}/>
          <button className="ctrl-btn" onClick={()=>onSearch(searchTerm)} style={{background:"#4f46e5",border:"none",borderRadius:6,color:"#fff",padding:"5px 9px",fontSize:11,cursor:"pointer"}}>→</button>
        </div>
        {searchTerm&&<button onClick={()=>{setSearchTerm("");onSearch("");}} style={{marginTop:5,background:"none",border:"none",color:"#334155",fontSize:10,cursor:"pointer",padding:0}}>✕ Clear</button>}
      </div>
      <div style={{height:1,background:"rgba(255,255,255,.05)"}}/>
      <div style={{padding:"9px 12px 8px"}}>
        <div style={{fontSize:8,color:"#1e293b",textTransform:"uppercase",letterSpacing:"0.12em",marginBottom:8}}>Node Types</div>
        <div style={{display:"flex",gap:6,flexWrap:"wrap"}}>
          {allNodeTypes.filter(t=>nodeCounts[t]).map(type=>{const on=activeNodeTypes.includes(type);const label=type==="payment_method"?"payment":type;const shape=type==="user"?"50%":type==="payment_method"?"3px":"2px";return(
            <button key={type} onClick={()=>setActiveNodeTypes(p=>on?p.filter(t=>t!==type):[...p,type])} style={{flex:type==="payment_method"?"1 1 100%":"1",padding:"7px 4px",border:`1px solid ${on?(NODE_COLORS[type]||"#64748b")+"55":"rgba(255,255,255,.06)"}`,borderRadius:7,background:on?(NODE_COLORS[type]||"#64748b")+"16":"rgba(255,255,255,.02)",cursor:"pointer",transition:"all .15s",display:"flex",flexDirection:"column",alignItems:"center",gap:5}}>
              <span style={{width:11,height:11,background:on?(NODE_COLORS[type]||"#64748b"):"#0f172a",borderRadius:shape,transform:type==="transaction"?"rotate(45deg)":"none",display:"block",border:`1.5px solid ${NODE_COLORS[type]||"#64748b"}`}}/>
              <span style={{fontSize:8,color:on?"#c7d2fe":"#334155",textTransform:"uppercase"}}>{label}</span>
              <span style={{fontSize:9,color:"#334155",fontFamily:"'DM Mono',monospace"}}>{nodeCounts[type]||0}</span>
            </button>
          );})}
        </div>
      </div>
      <div style={{height:1,background:"rgba(255,255,255,.05)"}}/>
      <div style={{padding:"9px 12px 12px"}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8}}>
          <span style={{fontSize:8,color:"#1e293b",textTransform:"uppercase",letterSpacing:"0.12em"}}>Edge Types</span>
          <button onClick={()=>setActiveEdgeTypes(allOn?[]:presentEdges)} style={{background:"none",border:"none",color:"#4f46e5",fontSize:9,cursor:"pointer",textTransform:"uppercase"}}>{allOn?"Hide All":"Show All"}</button>
        </div>
        <div style={{display:"flex",flexDirection:"column",gap:4}}>
          {presentEdges.map(type=>{const on=activeEdgeTypes.includes(type);return(
            <button key={type} className="edge-pill" onClick={()=>setActiveEdgeTypes(p=>on?p.filter(t=>t!==type):[...p,type])} style={{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"5px 8px",border:`1px solid ${on?EDGE_COLORS[type]+"44":"rgba(255,255,255,.05)"}`,borderRadius:5,background:on?EDGE_COLORS[type]+"12":"rgba(255,255,255,.02)",cursor:"pointer",opacity:on?1:.38,transition:"all .15s"}}>
              <div style={{display:"flex",alignItems:"center",gap:7}}>
                <span style={{width:7,height:7,borderRadius:"50%",background:EDGE_COLORS[type],display:"block",boxShadow:on?`0 0 5px ${EDGE_COLORS[type]}`:"none"}}/>
                <span style={{fontSize:9,color:on?"#c7d2fe":"#334155",textTransform:"uppercase",letterSpacing:"0.05em"}}>{type.replace(/_/g," ")}</span>
              </div>
              <span style={{fontSize:9,color:"#334155",fontFamily:"'DM Mono',monospace"}}>{edgeCounts[type]||0}</span>
            </button>
          );})}
        </div>
      </div>
    </div>
  );
}

/* ══════════════════════════════════════════════════════════════
   GRAPH PANEL
══════════════════════════════════════════════════════════════ */
function GraphPanel({graphData,loading,error,title,onExploreNode,onEditNode}){
  const containerRef=useRef(null);const cyRef=useRef(null);
  const [showFilters,setShowFilters]=useState(false);const [showPayments,setShowPayments]=useState(false);
  const [selected,setSelected]=useState(null);const [selInfo,setSelInfo]=useState(null);
  const [activeEdgeTypes,setActiveEdgeTypes]=useState(ALL_EDGE_TYPES);
  const [activeNodeTypes,setActiveNodeTypes]=useState(["user","transaction","payment_method"]);
  const [searchTerm,setSearchTerm]=useState("");

  const paymentSummary=graphData?.paymentSummary||[];
  const userPaymentMethods=graphData?.userPaymentMethods||[];
  const totalPaymentPeers=paymentSummary.reduce((s,m)=>s+(m.peerCount||0),0);
  const hasPaymentData=paymentSummary.length>0||userPaymentMethods.length>0;

  useEffect(()=>{setSelected(null);setSelInfo(null);setSearchTerm("");setActiveEdgeTypes(ALL_EDGE_TYPES);setActiveNodeTypes(["user","transaction","payment_method"]);setShowPayments(false);},[graphData]);

  useEffect(()=>{
    if(!containerRef.current||!graphData)return;
    if(cyRef.current){cyRef.current.destroy();cyRef.current=null;}
    const nodes=graphData.nodes.map(n=>{
      const data={id:n.id,label:n.label||n.id,type:n.type};
      if(n.type==="transaction"){["transactionId","amount","currency","timestamp","ip","deviceId","status","paymentMethod"].forEach(k=>{if(n[k]!=null)data[k]=n[k];});}
      if(n.type==="payment_method"){if(n.userCount!=null)data.userCount=n.userCount;}
      return{data};
    });
    const edges=graphData.edges.map(e=>({data:{id:e.id||`${e.source}_${e.target}_${e.type}_${Math.random().toString(36).slice(2)}`,source:e.source,target:e.target,type:e.type}}));
    if(!nodes.length)return;

    cyRef.current=cytoscape({
      container:containerRef.current,elements:[...nodes,...edges],
      style:[
        {selector:"node",style:{"background-color":ele=>NODE_COLORS[ele.data("type")]||"#64748b",label:"data(label)",color:"#e2e8f0","font-size":"10px","font-family":"DM Mono, monospace","text-valign":"bottom","text-halign":"center","text-margin-y":5,width:38,height:38,"border-width":2,"border-color":"rgba(255,255,255,.12)","text-wrap":"ellipsis","text-max-width":"90px","shadow-blur":14,"shadow-color":ele=>NODE_COLORS[ele.data("type")]||"#4f46e5","shadow-opacity":.4,"transition-property":"opacity, border-color, border-width","transition-duration":"0.18s"}},
        {selector:"node[type='transaction']",style:{shape:"diamond",width:36,height:36,"font-size":"9px","border-color":ele=>{const s=(ele.data("status")||"").toUpperCase();return STATUS_COLORS[s]||"rgba(255,255,255,.12)";},"border-width":ele=>{const s=(ele.data("status")||"").toUpperCase();return(s==="FLAGGED"||s==="FAILED")?3:2;}}},
        {selector:"node[type='payment_method']",style:{shape:"hexagon",width:32,height:32,"font-size":"8px","background-color":"#ec4899","border-color":"rgba(236,72,153,.5)","border-width":2,"shadow-color":"#ec4899","shadow-opacity":.3}},
        {selector:"edge",style:{"line-color":ele=>EDGE_COLORS[ele.data("type")]||"#94a3b8","target-arrow-color":ele=>EDGE_COLORS[ele.data("type")]||"#94a3b8","target-arrow-shape":"triangle","curve-style":"bezier",width:1.8,opacity:.75,"transition-property":"opacity, width","transition-duration":"0.18s"}},
        {selector:"edge[type='SAME_PAYMENT']",style:{"line-style":"dashed","line-dash-pattern":[6,3],width:1.4,opacity:.55}},
        {selector:".dimmed",style:{opacity:.07,"shadow-opacity":0}},
        {selector:".highlighted",style:{opacity:1,"border-color":"#f1f5f9","border-width":3.5,"shadow-opacity":.9,"z-index":10}},
        {selector:"edge.highlighted",style:{opacity:1,width:2.8}},
        {selector:":selected",style:{"border-color":"#f1f5f9","border-width":3.5}},
      ],
      layout:{name:"cose",animate:true,animationDuration:650,nodeRepulsion:10000,idealEdgeLength:120,gravity:.25,padding:40,randomize:false},
    });

    const cy=cyRef.current;
    cy.on("tap","node",evt=>{const n=evt.target;cy.elements().removeClass("dimmed highlighted").addClass("dimmed");n.closedNeighborhood().removeClass("dimmed").addClass("highlighted");n.addClass("highlighted");setSelected({group:"nodes",data:n.data()});setSelInfo({neighbours:n.neighborhood("node").length,edges:n.connectedEdges().length});setShowPayments(false);});
    cy.on("tap","edge",evt=>{const e=evt.target;cy.elements().removeClass("dimmed highlighted").addClass("dimmed");e.removeClass("dimmed").addClass("highlighted");e.source().removeClass("dimmed").addClass("highlighted");e.target().removeClass("dimmed").addClass("highlighted");setSelected({group:"edges",data:e.data()});setSelInfo(null);setShowPayments(false);});
    cy.on("tap",evt=>{if(evt.target===cy){cy.elements().removeClass("dimmed highlighted");setSelected(null);setSelInfo(null);}});

    cy.on("mouseover","node",evt=>{
      const n=evt.target,pos=evt.renderedPosition,d=n.data();
      const rect=containerRef.current.getBoundingClientRect();
      document.querySelectorAll(".cy-tooltip").forEach(t=>t.remove());
      const color=NODE_COLORS[d.type]||"#818cf8";
      let html=`<div style="color:${color};font-size:8px;font-weight:700;text-transform:uppercase;letter-spacing:.12em;margin-bottom:5px">${d.type==="payment_method"?"Payment Method":d.type}</div><div style="color:#f1f5f9;font-size:12px;margin-bottom:2px">${d.label}</div>`;
      if(d.type==="transaction"){
        const sc=STATUS_COLORS[(d.status||"").toUpperCase()]||"#64748b";
        html+=`<div style="color:#475569;font-size:10px;word-break:break-all;margin-bottom:6px">${d.transactionId||d.id}</div><div style="border-top:1px solid rgba(255,255,255,.06);padding-top:5px">`;
        if(d.amount!=null)html+=`<div style="display:flex;justify-content:space-between;margin-bottom:2px"><span style="color:#334155;font-size:9px">Amount</span><span style="color:#34d399;font-weight:700;font-size:11px">${fmtAmt(d.amount,d.currency)}</span></div>`;
        if(d.paymentMethod)html+=`<div style="display:flex;justify-content:space-between;margin-bottom:2px"><span style="color:#334155;font-size:9px">Payment</span><span style="color:#ec4899;font-size:10px">${d.paymentMethod}</span></div>`;
        if(d.status)html+=`<div style="display:flex;justify-content:space-between;margin-bottom:2px"><span style="color:#334155;font-size:9px">Status</span><span style="color:${sc};font-size:10px;font-weight:600">${d.status}</span></div>`;
        if(d.ip)html+=`<div style="display:flex;justify-content:space-between"><span style="color:#334155;font-size:9px">IP</span><span style="color:#64748b;font-size:9px">${d.ip}</span></div>`;
        html+=`</div>`;
      }else if(d.type==="payment_method"){
        html+=`<div style="color:#475569;font-size:10px;word-break:break-all;margin-bottom:4px">${d.id}</div>`;
        if(d.userCount!=null)html+=`<div style="border-top:1px solid rgba(255,255,255,.06);padding-top:5px;color:#ec4899;font-size:10px">Shared by ${d.userCount} users</div>`;
      }else{html+=`<div style="color:#475569;font-size:10px;word-break:break-all">${d.id}</div>`;}
      html+=`<div style="color:#334155;font-size:9px;margin-top:5px;padding-top:5px;border-top:1px solid rgba(255,255,255,.06)">Connections: <span style="color:${color}">${n.degree()}</span></div>`;
      const tip=document.createElement("div");tip.className="cy-tooltip";tip.innerHTML=html;
      tip.style.left=(rect.left+pos.x+14)+"px";tip.style.top=(rect.top+pos.y-10)+"px";
      document.body.appendChild(tip);
    });
    cy.on("mouseover","edge",evt=>{
      const e=evt.target,pos=evt.renderedPosition;const rect=containerRef.current.getBoundingClientRect();
      document.querySelectorAll(".cy-tooltip").forEach(t=>t.remove());
      const color=EDGE_COLORS[e.data("type")]||"#94a3b8";
      const tip=document.createElement("div");tip.className="cy-tooltip";
      let html=`<div style="color:${color};font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;margin-bottom:6px">${e.data("type").replace(/_/g," ")}</div><div style="color:#94a3b8;font-size:10px">${e.data("source")}</div><div style="color:#334155;font-size:9px;margin:3px 0">→</div><div style="color:#94a3b8;font-size:10px">${e.data("target")}</div>`;
      if(e.data("type")==="SAME_PAYMENT"){html+=`<div style="border-top:1px solid rgba(255,255,255,.06);padding-top:5px;margin-top:5px;color:#f9a8d4;font-size:9px">Shared payment method connection</div>`;}
      tip.innerHTML=html;
      tip.style.left=(rect.left+pos.x+14)+"px";tip.style.top=(rect.top+pos.y-10)+"px";
      document.body.appendChild(tip);
    });
    cy.on("mouseout pan zoom",()=>document.querySelectorAll(".cy-tooltip").forEach(t=>t.remove()));
    return()=>{document.querySelectorAll(".cy-tooltip").forEach(t=>t.remove());if(cyRef.current){cyRef.current.destroy();cyRef.current=null;}};
  },[graphData]);

  useEffect(()=>{cyRef.current?.edges().forEach(e=>e.style("display",activeEdgeTypes.includes(e.data("type"))?"element":"none"));},[activeEdgeTypes]);
  useEffect(()=>{cyRef.current?.nodes().forEach(n=>n.style("display",activeNodeTypes.includes(n.data("type"))?"element":"none"));},[activeNodeTypes]);

  const handleSearch=useCallback(term=>{
    const cy=cyRef.current;if(!cy)return;const q=(term!==undefined?term:searchTerm).trim();
    cy.elements().removeClass("dimmed highlighted");if(!q)return;
    const matched=cy.nodes().filter(n=>n.data("label").toLowerCase().includes(q.toLowerCase())||n.data("id").toLowerCase().includes(q.toLowerCase()));
    if(!matched.length)return;cy.elements().addClass("dimmed");
    matched.forEach(n=>{n.closedNeighborhood().removeClass("dimmed").addClass("highlighted");n.addClass("highlighted");});
    cy.animate({fit:{eles:matched,padding:70}},{duration:400});
  },[searchTerm]);

  useEffect(()=>{if(!searchTerm)cyRef.current?.elements().removeClass("dimmed highlighted");},[searchTerm]);

  const clearSel=()=>{cyRef.current?.elements().removeClass("dimmed highlighted");setSelected(null);setSelInfo(null);};
  const fitGraph=()=>cyRef.current?.fit(undefined,40);
  const resetLayout=()=>cyRef.current?.layout({name:"cose",animate:true,nodeRepulsion:10000,idealEdgeLength:120,gravity:.25}).run();
  const zoomIn=()=>{const cy=cyRef.current;if(!cy)return;cy.zoom({level:cy.zoom()*1.3,renderedPosition:{x:containerRef.current.clientWidth/2,y:containerRef.current.clientHeight/2}});};
  const zoomOut=()=>{const cy=cyRef.current;if(!cy)return;cy.zoom({level:cy.zoom()*.75,renderedPosition:{x:containerRef.current.clientWidth/2,y:containerRef.current.clientHeight/2}});};

  const nodeCount=graphData?.nodes?.length??0,edgeCount=graphData?.edges?.length??0;
  const pmNodeCount=graphData?.nodes?.filter(n=>n.type==="payment_method").length??0;

  return(
    <div style={{flex:1,display:"flex",flexDirection:"column",position:"relative",overflow:"hidden"}}>
      <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"7px 14px",borderBottom:"1px solid rgba(99,102,241,.1)",background:"rgba(0,0,0,.28)",flexShrink:0,gap:8,flexWrap:"wrap"}}>
        <div style={{display:"flex",alignItems:"center",gap:10,flexWrap:"wrap"}}>
          <span style={{fontSize:12,fontWeight:700,color:"#c7d2fe"}}>{title||"Select a row to explore"}</span>
          {graphData&&<div style={{display:"flex",gap:5}}>
            {[[nodeCount,"nodes","#4f46e5","#818cf8"],[edgeCount,"edges","#7c3aed","#a78bfa"]].map(([n,lbl,bg,fg])=>(<span key={lbl} style={{fontSize:9,fontFamily:"'DM Mono',monospace",background:`${bg}22`,border:`1px solid ${bg}44`,color:fg,borderRadius:20,padding:"2px 8px"}}>{n} {lbl}</span>))}
            {pmNodeCount>0&&<span style={{fontSize:9,fontFamily:"'DM Mono',monospace",background:"rgba(236,72,153,.12)",border:"1px solid rgba(236,72,153,.3)",color:"#f9a8d4",borderRadius:20,padding:"2px 8px"}}>{pmNodeCount} pay peers</span>}
          </div>}
          {selInfo&&<span style={{fontSize:9,background:"rgba(99,102,241,.1)",border:"1px solid rgba(99,102,241,.2)",borderRadius:20,padding:"2px 10px",color:"#818cf8",fontFamily:"'DM Mono',monospace"}}>◉ {selInfo.neighbours} nbrs · {selInfo.edges} edges</span>}
        </div>
        <div style={{display:"flex",gap:5,alignItems:"center"}}>
          {selected&&<button className="danger-btn" onClick={clearSel} style={{background:"transparent",border:"1px solid rgba(239,68,68,.25)",color:"#f87171",borderRadius:5,padding:"4px 10px",fontSize:11,cursor:"pointer"}}>✕ Clear</button>}
          {hasPaymentData&&(<button onClick={()=>{setShowPayments(p=>!p);if(!showPayments)setSelected(null);}} style={{background:showPayments?"rgba(236,72,153,.18)":"rgba(255,255,255,.04)",border:showPayments?"1px solid #ec4899":"1px solid rgba(255,255,255,.08)",color:showPayments?"#f9a8d4":"#475569",borderRadius:5,padding:"4px 11px",fontSize:11,cursor:"pointer",fontWeight:600,display:"flex",alignItems:"center",gap:5}}>
            <span style={{width:6,height:6,borderRadius:"50%",background:"#ec4899",display:"block",opacity:showPayments?1:.4}}/>Payments{totalPaymentPeers>0&&<span style={{fontSize:9,fontFamily:"'DM Mono',monospace",opacity:.7}}>({totalPaymentPeers})</span>}
          </button>)}
          <button onClick={()=>setShowFilters(f=>!f)} style={{background:showFilters?"rgba(99,102,241,.18)":"rgba(255,255,255,.04)",border:showFilters?"1px solid #6366f1":"1px solid rgba(255,255,255,.08)",color:showFilters?"#818cf8":"#475569",borderRadius:5,padding:"4px 11px",fontSize:12,cursor:"pointer",fontWeight:600}}>⚙ Filters</button>
          {[["⊕",zoomIn,"Zoom in"],["⊖",zoomOut,"Zoom out"],["⊞",fitGraph,"Fit"],["↺",resetLayout,"Re-layout"]].map(([icon,fn,lbl])=>(<button key={lbl} className="icon-btn" title={lbl} onClick={fn} style={{background:"rgba(255,255,255,.04)",border:"1px solid rgba(255,255,255,.07)",color:"#475569",borderRadius:5,padding:"4px 10px",fontSize:13,cursor:"pointer"}}>{icon}</button>))}
        </div>
      </div>

      {showFilters&&graphData&&<GraphFilterPanel graphData={graphData} activeEdgeTypes={activeEdgeTypes} setActiveEdgeTypes={setActiveEdgeTypes} activeNodeTypes={activeNodeTypes} setActiveNodeTypes={setActiveNodeTypes} searchTerm={searchTerm} setSearchTerm={setSearchTerm} onSearch={handleSearch}/>}
      {selected&&!showPayments&&<DetailPanel selected={selected} onClose={clearSel} onExplore={d=>{clearSel();onExploreNode&&onExploreNode(d);}} onEdit={onEditNode}/>}
      {showPayments&&<PaymentSummaryPanel paymentSummary={paymentSummary} userPaymentMethods={userPaymentMethods} onClose={()=>setShowPayments(false)} onExplorePeer={peer=>{setShowPayments(false);onExploreNode&&onExploreNode({id:peer.userId,label:peer.name,type:"user"});}}/>}

      {loading&&<div style={{position:"absolute",inset:0,display:"flex",alignItems:"center",justifyContent:"center",zIndex:15,background:"rgba(6,12,26,.65)",backdropFilter:"blur(4px)"}}><div style={{textAlign:"center"}}><div style={{width:42,height:42,borderRadius:"50%",border:"3px solid rgba(99,102,241,.18)",borderTopColor:"#818cf8",animation:"spin .8s linear infinite",margin:"0 auto 12px"}}/><div style={{color:"#334155",fontSize:11,letterSpacing:"0.12em"}}>LOADING GRAPH…</div></div></div>}
      {error&&<div style={{position:"absolute",inset:0,display:"flex",alignItems:"center",justifyContent:"center",zIndex:15}}><div style={{background:"rgba(239,68,68,.08)",border:"1px solid rgba(239,68,68,.22)",borderRadius:10,padding:"20px 28px",textAlign:"center"}}><div style={{fontSize:26,marginBottom:8}}>⚠</div><div style={{color:"#fca5a5",fontSize:12}}>{error}</div></div></div>}
      {!loading&&!error&&!graphData&&<div style={{position:"absolute",inset:0,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:12,pointerEvents:"none"}}><div style={{fontSize:54,opacity:.06}}>⬡</div><div style={{color:"#1e293b",fontSize:12,letterSpacing:"0.06em"}}>Click any row to visualise its graph</div></div>}

      <div ref={containerRef} style={{flex:1,opacity:loading?.12:1,transition:"opacity .3s"}}/>

      {graphData&&<div style={{position:"absolute",bottom:14,left:14,background:"rgba(6,12,26,.92)",border:"1px solid rgba(99,102,241,.15)",borderRadius:8,padding:"9px 13px",backdropFilter:"blur(12px)",maxWidth:560}}>
        <div style={{fontSize:7,color:"#1e293b",textTransform:"uppercase",letterSpacing:"0.13em",marginBottom:6}}>Click node/edge to inspect · Background to deselect</div>
        <div style={{display:"flex",flexWrap:"wrap",gap:"5px 12px",marginBottom:5}}>
          {Object.entries(EDGE_COLORS).map(([k,v])=>(<div key={k} style={{display:"flex",alignItems:"center",gap:4,opacity:activeEdgeTypes.includes(k)?1:.22}}><span style={{width:6,height:6,borderRadius:"50%",background:v,display:"block"}}/><span style={{fontSize:8,color:"#334155",textTransform:"uppercase"}}>{k.replace(/_/g," ")}</span></div>))}
        </div>
        <div style={{display:"flex",gap:12,paddingTop:5,borderTop:"1px solid rgba(255,255,255,.04)"}}>
          {[["user","◯"],["transaction","◆"],["payment_method","⬡"]].map(([t,s])=>(<div key={t} style={{display:"flex",alignItems:"center",gap:4,opacity:activeNodeTypes.includes(t)?1:.22}}><span style={{color:NODE_COLORS[t],fontSize:10}}>{s}</span><span style={{fontSize:8,color:"#334155",textTransform:"uppercase"}}>{t==="payment_method"?"payment":t}</span></div>))}
        </div>
        <div style={{display:"flex",gap:10,paddingTop:5,borderTop:"1px solid rgba(255,255,255,.04)",marginTop:5}}>
          <span style={{fontSize:7,color:"#1e293b",textTransform:"uppercase",paddingTop:1}}>TX Status:</span>
          {Object.entries(STATUS_COLORS).map(([k,v])=>(<div key={k} style={{display:"flex",alignItems:"center",gap:3}}><span style={{width:5,height:5,borderRadius:1,background:v,display:"block",transform:"rotate(45deg)"}}/><span style={{fontSize:7,color:"#334155",textTransform:"uppercase"}}>{k}</span></div>))}
        </div>
      </div>}
    </div>
  );
}

/* ══════════════════════════════════════════════════════════════
   USERS TAB
══════════════════════════════════════════════════════════════ */
function UsersTab({onSelectUser,selectedUserId,onAdd,onEdit}){
  const [users,setUsers]=useState([]);const [total,setTotal]=useState(0);const [page,setPage]=useState(0);const SIZE=20;
  const [search,setSearch]=useState("");const [phone,setPhone]=useState("");
  const [loading,setLoading]=useState(false);const [error,setError]=useState(null);

  const fetch_=useCallback(async(p,f)=>{
    setLoading(true);setError(null);
    try{
      const q=new URLSearchParams({page:p,size:SIZE});
      if(f.search) q.set("search",f.search);
      if(f.phone)  q.set("phone",f.phone);
      const d=await apiFetch(`/users?${q}`);
      setUsers(d.content??d.data??(Array.isArray(d)?d:[]));
      setTotal(d.total??d.totalElements??0);
    }catch(e){setError(e.message);}finally{setLoading(false);}
  },[]);

  const getF=()=>({search,phone});
  useEffect(()=>{fetch_(0,{});},[fetch_]);
  const apply=()=>{setPage(0);fetch_(0,getF());};
  const clear=()=>{setSearch("");setPhone("");setPage(0);fetch_(0,{});};
  const goPage=p=>{setPage(p);fetch_(p,getF());};

  return(
    <div style={{display:"flex",flexDirection:"column",flex:1,overflow:"hidden"}}>
      <div style={S.bar}>
        <input style={{...S.inp,flex:1,minWidth:180}} placeholder="🔍 Search name or user ID…" value={search} onChange={e=>setSearch(e.target.value)} onKeyDown={e=>e.key==="Enter"&&apply()}/>
        <input style={{...S.inp,width:130}} placeholder="Phone…" value={phone} onChange={e=>setPhone(e.target.value)} onKeyDown={e=>e.key==="Enter"&&apply()}/>
        <button className="ctrl-btn" style={S.btn} onClick={apply}>Search</button>
        <button className="ghost-btn" style={{...S.btn,...S.ghost}} onClick={clear}>Clear</button>
        <span style={S.badge}>{total.toLocaleString()} users</span>
        <button className="ctrl-btn" onClick={onAdd} style={{...S.btn,marginLeft:4,background:"rgba(79,70,229,.2)",border:"1px solid rgba(79,70,229,.4)",color:"#818cf8"}}>+ Add</button>
      </div>
      {error&&<div style={S.err}>{error}</div>}
      <div style={{flex:1,overflow:"auto"}}>
        <table style={{width:"100%",borderCollapse:"collapse",fontSize:12}}>
          <thead><tr>{["User ID","Name","Email","Phone","Address",""].map(h=><th key={h} style={S.th}>{h}</th>)}</tr></thead>
          <tbody>
            {loading?Array.from({length:8}).map((_,i)=><tr key={i}><td colSpan={6} style={S.td}><div style={S.skel}/></td></tr>)
              :users.map(u=>(<tr key={u.userId} className={`data-row ${selectedUserId===u.userId?"selected":""}`} style={{borderBottom:"1px solid rgba(255,255,255,.04)",cursor:"pointer"}} onClick={()=>onSelectUser(u)}>
                <td style={{...S.td,...S.mono}}>{u.userId}</td>
                <td style={{...S.td,color:"#c7d2fe",fontWeight:600}}>{u.name}</td>
                <td style={S.td}>{u.email}</td><td style={S.td}>{u.phone}</td><td style={S.td}>{u.address}</td>
                <td style={S.td} onClick={e=>e.stopPropagation()}><button onClick={()=>onEdit(u)} style={{background:"rgba(99,102,241,.1)",border:"1px solid rgba(99,102,241,.2)",borderRadius:4,color:"#818cf8",padding:"2px 8px",fontSize:10,cursor:"pointer"}}>Edit</button></td>
              </tr>))}
          </tbody>
        </table>
      </div>
      <Pagination page={page} totalPages={Math.ceil(total/SIZE)} onPage={goPage}/>
    </div>
  );
}

/* ══════════════════════════════════════════════════════════════
   TRANSACTIONS TAB
══════════════════════════════════════════════════════════════ */
function TransactionsTab({onSelectTx,selectedTxId,onAdd,onEdit}){
  const [txs,setTxs]=useState([]);const [total,setTotal]=useState(0);const [page,setPage]=useState(0);const SIZE=50;
  const [search,setSearch]=useState("");const [ip,setIp]=useState("");const [deviceId,setDeviceId]=useState("");
  const [minAmt,setMinAmt]=useState("");const [maxAmt,setMaxAmt]=useState("");
  const [status,setStatus]=useState("");const [pmFilter,setPmFilter]=useState("");
  const [sortKey,setSortKey]=useState("amount");const [sortDir,setSortDir]=useState("desc");
  const [loading,setLoading]=useState(false);const [error,setError]=useState(null);

  const getF=()=>({search,ip,deviceId,minAmount:minAmt,maxAmount:maxAmt,status,paymentMethod:pmFilter});

  const fetch_=useCallback(async(p,f)=>{
    setLoading(true);setError(null);
    try{
      const q=new URLSearchParams({page:p,size:SIZE});
      if(f.search)        q.set("search",f.search);
      if(f.ip)            q.set("ip",f.ip);
      if(f.deviceId)      q.set("deviceId",f.deviceId);
      if(f.minAmount)     q.set("minAmount",f.minAmount);
      if(f.maxAmount)     q.set("maxAmount",f.maxAmount);
      if(f.status)        q.set("status",f.status);
      if(f.paymentMethod) q.set("paymentMethod",f.paymentMethod);
      const d=await apiFetch(`/transactions?${q}`);
      setTxs(d.content??d.data??(Array.isArray(d)?d:[]));
      setTotal(d.total??d.totalElements??0);
    }catch(e){setError(e.message);}finally{setLoading(false);}
  },[]);

  useEffect(()=>{fetch_(0,{});},[fetch_]);
  const apply=()=>{setPage(0);fetch_(0,getF());};
  const clear=()=>{setSearch("");setIp("");setDeviceId("");setMinAmt("");setMaxAmt("");setStatus("");setPmFilter("");setPage(0);fetch_(0,{});};
  const goPage=p=>{setPage(p);fetch_(p,getF());};

  const sorted=useMemo(()=>[...txs].sort((a,b)=>{const av=a[sortKey],bv=b[sortKey];if(typeof av==="number")return sortDir==="asc"?av-bv:bv-av;return sortDir==="asc"?String(av).localeCompare(String(bv)):String(bv).localeCompare(String(av));}),[txs,sortKey,sortDir]);
  const toggleSort=k=>{if(sortKey===k)setSortDir(d=>d==="asc"?"desc":"asc");else{setSortKey(k);setSortDir("desc");}};
  const SI=({k})=><span style={{fontSize:9,color:sortKey===k?"#818cf8":"#1e293b",marginLeft:2}}>{sortKey!==k?"↕":sortDir==="asc"?"↑":"↓"}</span>;

  return(
    <div style={{display:"flex",flexDirection:"column",flex:1,overflow:"hidden"}}>
      <div style={{...S.bar,borderBottom:"none",paddingBottom:3}}>
        <input style={{...S.inp,flex:1,minWidth:170}} placeholder="🔍 Search transaction ID…" value={search} onChange={e=>setSearch(e.target.value)} onKeyDown={e=>e.key==="Enter"&&apply()}/>
        <input style={{...S.inp,width:120}} placeholder="IP…" value={ip} onChange={e=>setIp(e.target.value)} onKeyDown={e=>e.key==="Enter"&&apply()}/>
        <input style={{...S.inp,width:120}} placeholder="Device ID…" value={deviceId} onChange={e=>setDeviceId(e.target.value)} onKeyDown={e=>e.key==="Enter"&&apply()}/>
      </div>
      <div style={S.bar}>
        <input style={{...S.inp,width:80}} placeholder="Min $" type="number" value={minAmt} onChange={e=>setMinAmt(e.target.value)}/>
        <input style={{...S.inp,width:80}} placeholder="Max $" type="number" value={maxAmt} onChange={e=>setMaxAmt(e.target.value)}/>
        <select value={status} onChange={e=>setStatus(e.target.value)} style={{...S.inp,width:115,cursor:"pointer",background:"#080f20"}}><option value="">All Status</option>{STATUS_OPTS.map(s=><option key={s} value={s}>{s}</option>)}</select>
        <input style={{...S.inp,width:115}} placeholder="Payment…" value={pmFilter} onChange={e=>setPmFilter(e.target.value)} onKeyDown={e=>e.key==="Enter"&&apply()}/>
        <button className="ctrl-btn" style={S.btn} onClick={apply}>Search</button>
        <button className="ghost-btn" style={{...S.btn,...S.ghost}} onClick={clear}>Clear</button>
        <span style={S.badge}>{total.toLocaleString()} txns</span>
        <button className="ctrl-btn" onClick={onAdd} style={{...S.btn,marginLeft:4,background:"rgba(124,58,237,.2)",border:"1px solid rgba(124,58,237,.4)",color:"#a78bfa"}}>+ Add</button>
      </div>
      {error&&<div style={S.err}>{error}</div>}
      <div style={{flex:1,overflow:"auto"}}>
        <table style={{width:"100%",borderCollapse:"collapse",fontSize:12}}>
          <thead><tr>
            <th style={S.th}>Transaction ID</th>
            <th style={{...S.th,cursor:"pointer"}} onClick={()=>toggleSort("amount")}>Amount <SI k="amount"/></th>
            <th style={S.th}>Payment</th><th style={S.th}>Status</th>
            <th style={{...S.th,cursor:"pointer"}} onClick={()=>toggleSort("ip")}>IP <SI k="ip"/></th>
            <th style={S.th}>Device</th><th style={S.th}></th>
          </tr></thead>
          <tbody>
            {loading?Array.from({length:10}).map((_,i)=><tr key={i}><td colSpan={7} style={S.td}><div style={S.skel}/></td></tr>)
              :sorted.map(tx=>{const sc=STATUS_COLORS[(tx.status||"").toUpperCase()]||"#64748b";return(
                <tr key={tx.transactionId} className={`data-row ${selectedTxId===tx.transactionId?"selected":""}`} style={{borderBottom:"1px solid rgba(255,255,255,.04)",cursor:"pointer"}} onClick={()=>onSelectTx(tx)}>
                  <td style={{...S.td,...S.mono}}>{tx.transactionId}</td>
                  <td style={{...S.td,color:"#34d399",fontFamily:"'DM Mono',monospace",fontWeight:600}}>{CURRENCY_SYMS[tx.currency]||"$"}{Number(tx.amount||0).toLocaleString(undefined,{minimumFractionDigits:2})}</td>
                  <td style={{...S.td,color:"#ec4899",fontSize:10}}>{tx.paymentMethod||"—"}</td>
                  <td style={S.td}>{tx.status?<span style={{background:`${sc}18`,border:`1px solid ${sc}44`,color:sc,borderRadius:10,padding:"1px 8px",fontSize:9,fontWeight:600}}>{tx.status}</span>:<span style={{color:"#1e293b",fontSize:10}}>—</span>}</td>
                  <td style={{...S.td,...S.mono}}>{tx.ip}</td>
                  <td style={{...S.td,...S.mono,maxWidth:95}}>{tx.deviceId}</td>
                  <td style={S.td} onClick={e=>e.stopPropagation()}><button onClick={()=>onEdit(tx)} style={{background:"rgba(124,58,237,.1)",border:"1px solid rgba(124,58,237,.2)",borderRadius:4,color:"#a78bfa",padding:"2px 8px",fontSize:10,cursor:"pointer"}}>Edit</button></td>
                </tr>
              );})}
          </tbody>
        </table>
      </div>
      <Pagination page={page} totalPages={Math.ceil(total/SIZE)} onPage={goPage}/>
    </div>
  );
}

/* ── Pagination ── */
function Pagination({page,totalPages,onPage}){
  if(totalPages<=1)return null;
  const start=Math.max(0,page-2),end=Math.min(totalPages-1,page+2);const pages=[];for(let i=start;i<=end;i++)pages.push(i);
  return(<div style={{display:"flex",alignItems:"center",gap:4,padding:"7px 13px",borderTop:"1px solid rgba(255,255,255,.04)",background:"rgba(0,0,0,.22)",flexShrink:0,flexWrap:"wrap"}}>
    {[["«",0],["‹",page-1]].map(([l,p])=><button key={l} className="page-btn" disabled={page===0} style={S.pgBtn} onClick={()=>onPage(p)}>{l}</button>)}
    {start>0&&<span style={{color:"#1e293b",fontSize:12}}>…</span>}
    {pages.map(p=><button key={p} className="page-btn" onClick={()=>onPage(p)} style={{...S.pgBtn,...(p===page?S.pgActive:{})}}>{p+1}</button>)}
    {end<totalPages-1&&<span style={{color:"#1e293b",fontSize:12}}>…</span>}
    {[["›",page+1],["»",totalPages-1]].map(([l,p])=><button key={l} className="page-btn" disabled={page>=totalPages-1} style={S.pgBtn} onClick={()=>onPage(p)}>{l}</button>)}
    <span style={{fontSize:10,color:"#1e293b",marginLeft:6,fontFamily:"'DM Mono',monospace"}}>{page+1}/{totalPages.toLocaleString()}</span>
  </div>);
}

/* ══════════════════════════════════════════════════════════════
   APP
══════════════════════════════════════════════════════════════ */
function App(){
  const [screen,setScreen]=useState("landing");
  const [tab,setTab]=useState("users");
  const [selUser,setSelUser]=useState(null);const [selTx,setSelTx]=useState(null);
  const [graphData,setGraphData]=useState(null);const [graphLoading,setGraphLoading]=useState(false);
  const [graphError,setGraphError]=useState(null);const [graphTitle,setGraphTitle]=useState("");
  const [userModal,setUserModal]=useState(null);const [txModal,setTxModal]=useState(null);
  const [userRefresh,setUserRefresh]=useState(0);const [txRefresh,setTxRefresh]=useState(0);

  const loadUserGraph=useCallback(async user=>{
    setSelUser(user);setSelTx(null);setGraphLoading(true);setGraphError(null);
    setGraphTitle(`User: ${user.name||user.userId}`);
    try{const d=await apiFetch(`/relationships/user/${user.userId}`);setGraphData(d);}
    catch(e){setGraphError(e.message);}finally{setGraphLoading(false);}
  },[]);

  const loadTxGraph=useCallback(async tx=>{
    setSelTx(tx);setSelUser(null);setGraphLoading(true);setGraphError(null);
    setGraphTitle(`Transaction: ${tx.transactionId}`);
    try{const d=await apiFetch(`/relationships/transaction/${tx.transactionId}`);setGraphData(d);}
    catch(e){setGraphError(e.message);}finally{setGraphLoading(false);}
  },[]);

  const handleExploreNode=useCallback(async nodeData=>{
    if(nodeData.type==="user"){setTab("users");await loadUserGraph({userId:nodeData.id,name:nodeData.label});}
    else if(nodeData.type==="transaction"){setTab("transactions");await loadTxGraph({transactionId:nodeData.id});}
  },[loadUserGraph,loadTxGraph]);

  const handleEditNode=useCallback(nodeData=>{
    if(nodeData.type==="user")setUserModal({mode:"edit",data:{userId:nodeData.id,name:nodeData.label}});
    else if(nodeData.type==="transaction")setTxModal({mode:"edit",data:{transactionId:nodeData.id}});
  },[]);

  if(screen==="landing")return<LandingPage onEnter={()=>setScreen("dashboard")}/>;

  return(
    <div style={{display:"flex",flexDirection:"column",height:"100vh",width:"100vw",background:"#060c1a",color:"#e2e8f0",fontFamily:"'DM Sans',sans-serif",overflow:"hidden"}}>
      <header style={{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"0 22px",height:52,background:"rgba(7,13,26,.99)",borderBottom:"1px solid rgba(99,102,241,.15)",flexShrink:0,zIndex:30}}>
        <div style={{display:"flex",alignItems:"center",gap:18}}>
          <div style={{display:"flex",alignItems:"center",gap:8,cursor:"pointer"}} onClick={()=>setScreen("landing")}>
            <span style={{fontSize:20,color:"#818cf8"}}>⬡</span>
            <span style={{fontSize:16,fontWeight:800,letterSpacing:"0.14em",color:"#f1f5f9",fontFamily:"'DM Mono',monospace"}}>FRAML<span style={{color:"#818cf8"}}>GRAPH</span></span>
          </div>
          <span style={{fontSize:9,color:"#1e293b",letterSpacing:"0.1em",textTransform:"uppercase",borderLeft:"1px solid rgba(255,255,255,.06)",paddingLeft:14}}>Transaction Relationship Intelligence</span>
        </div>
        {(selUser||selTx)&&(<div style={{display:"flex",alignItems:"center",gap:7,background:"rgba(99,102,241,.09)",border:"1px solid rgba(99,102,241,.2)",borderRadius:20,padding:"4px 13px"}}>
          <span style={{width:6,height:6,borderRadius:"50%",background:"#818cf8",boxShadow:"0 0 7px #818cf8",display:"block"}}/>
          <span style={{fontSize:11,color:"#c7d2fe",fontWeight:600}}>{selUser?(selUser.name||selUser.userId):selTx?.transactionId}</span>
        </div>)}
      </header>
      <div style={{display:"flex",flex:1,overflow:"hidden"}}>
        <div style={{width:700,minWidth:480,display:"flex",flexDirection:"column",borderRight:"1px solid rgba(99,102,241,.1)",background:"#080f20"}}>
          <div style={{display:"flex",borderBottom:"1px solid rgba(99,102,241,.1)",background:"#060c1a",flexShrink:0}}>
            {[["users","◉ Users"],["transactions","⬡ Transactions"]].map(([k,lbl])=>(<button key={k} onClick={()=>setTab(k)} style={{flex:1,padding:"12px 0",border:"none",background:tab===k?"rgba(99,102,241,.07)":"transparent",color:tab===k?"#818cf8":"#334155",cursor:"pointer",fontSize:13,fontWeight:700,letterSpacing:"0.06em",borderBottom:tab===k?"2px solid #818cf8":"2px solid transparent",transition:"all .2s"}}>{lbl}</button>))}
          </div>
          {tab==="users"
            ?<UsersTab key={userRefresh} onSelectUser={loadUserGraph} selectedUserId={selUser?.userId} onAdd={()=>setUserModal({mode:"add"})} onEdit={u=>setUserModal({mode:"edit",data:u})}/>
            :<TransactionsTab key={txRefresh} onSelectTx={loadTxGraph} selectedTxId={selTx?.transactionId} onAdd={()=>setTxModal({mode:"add"})} onEdit={tx=>setTxModal({mode:"edit",data:tx})}/>
          }
        </div>
        <div style={{flex:1,display:"flex",flexDirection:"column",background:"#060c1a",backgroundImage:"radial-gradient(ellipse at 15% 50%,rgba(79,70,229,.05) 0%,transparent 55%),radial-gradient(ellipse at 85% 20%,rgba(124,58,237,.03) 0%,transparent 50%)"}}>
          <GraphPanel graphData={graphData} loading={graphLoading} error={graphError} title={graphTitle} onExploreNode={handleExploreNode} onEditNode={handleEditNode}/>
        </div>
      </div>
      {userModal&&<UserModal editUser={userModal.mode==="edit"?userModal.data:null} onClose={()=>setUserModal(null)} onSaved={()=>setUserRefresh(r=>r+1)}/>}
      {txModal&&<TransactionModal editTx={txModal.mode==="edit"?txModal.data:null} onClose={()=>setTxModal(null)} onSaved={()=>setTxRefresh(r=>r+1)}/>}
    </div>
  );
}

const S={
  bar:{display:"flex",flexWrap:"wrap",gap:7,padding:"9px 13px",borderBottom:"1px solid rgba(255,255,255,.04)",background:"rgba(0,0,0,.2)",flexShrink:0,alignItems:"center"},
  inp:{background:"rgba(255,255,255,.05)",border:"1px solid rgba(99,102,241,.16)",borderRadius:6,color:"#e2e8f0",padding:"6px 9px",fontSize:12,outline:"none",width:148,fontFamily:"'DM Sans',sans-serif",transition:"border-color .2s"},
  btn:{background:"#4f46e5",border:"none",borderRadius:6,color:"#fff",padding:"6px 13px",fontSize:12,fontWeight:700,cursor:"pointer",letterSpacing:"0.05em",transition:"background .15s"},
  ghost:{background:"transparent",border:"1px solid rgba(99,102,241,.25)",color:"#818cf8"},
  badge:{marginLeft:"auto",fontSize:10,color:"#334155",background:"rgba(99,102,241,.06)",padding:"3px 9px",borderRadius:20,fontFamily:"'DM Mono',monospace"},
  err:{background:"rgba(239,68,68,.07)",borderBottom:"1px solid rgba(239,68,68,.18)",color:"#fca5a5",padding:"7px 13px",fontSize:12,flexShrink:0},
  th:{padding:"9px 11px",textAlign:"left",color:"#334155",background:"rgba(0,0,0,.38)",fontWeight:700,letterSpacing:"0.07em",fontSize:9,textTransform:"uppercase",borderBottom:"1px solid rgba(255,255,255,.04)",position:"sticky",top:0,zIndex:2},
  td:{padding:"8px 11px",color:"#64748b",maxWidth:140,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},
  mono:{fontFamily:"'DM Mono',monospace",fontSize:10},
  skel:{height:12,background:"rgba(255,255,255,.04)",borderRadius:4,animation:"pulse 1.5s ease-in-out infinite"},
  pgBtn:{background:"rgba(255,255,255,.03)",border:"1px solid rgba(255,255,255,.06)",color:"#334155",borderRadius:4,padding:"3px 8px",fontSize:12,cursor:"pointer",minWidth:26,textAlign:"center",transition:"all .15s"},
  pgActive:{background:"rgba(99,102,241,.16)",border:"1px solid #6366f1",color:"#c7d2fe"},
};

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>